% ---
% description: PDF Attachment Segment
% ---

% ---

\ExplSyntaxOn

\tl_new:N \g__pdfatt_shipout_tl
\prop_new:N \g__pdfatt_seen_prop

\cs_new_protected:Npn \__pdfatt_includepdf:nn #1#2
{
    \includepdf[
        pagecommand={\thispagestyle{empty}},
        width={\dim_use:N \paperwidth},
        link={true},
        linkname={#1},
        pages={-},
    ]{#2}
}

\cs_new_protected:Npn \__pdfatt_add_if_new:nnn #1#2#3
{
    % #1 = label, #2 = title, #3 = file
    \prop_if_in:NnF \g__pdfatt_seen_prop {#3}
    {
        \prop_gput:Nnn \g__pdfatt_seen_prop {#3} {#1}
        \tl_gput_right:Nn \g__pdfatt_shipout_tl
        {
            \phantomsection
            \bookmark[dest={#1.1}]{#2}
            \__pdfatt_includepdf:nn {#1}{#3}
        }
    }
}

\NewDocumentCommand \AddPdfAttachment { m m m } {
    \__pdfatt_add_if_new:nnn {#1}{#2}{#3}
}

\NewDocumentCommand \ShipoutPdfAttachments { } {
    \g__pdfatt_shipout_tl
}

\AddToHook{enddocument}{\ShipoutPdfAttachments}

\ExplSyntaxOff
